// Prisma schema for Broersma Bouwadvies Backoffice
// Connected to Supabase PostgreSQL

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

enum LeadStatus {
  Nieuw
  Calculatie
  OfferteVerzonden
  Opdracht
  Archief
}

enum QuoteApprovalStatus {
  none
  pending
  approved
  rejected
}

enum Priority {
  normal
  high
  urgent
}

enum EngineerType {
  rekenaar
  tekenaar
}


model Lead {
  id                  String              @id @default(cuid())
  clientName          String
  clientEmail         String?
  clientPhone         String?
  projectType         String
  city                String
  address             String?
  status              LeadStatus          @default(Nieuw)
  value               Float               @default(0)
  createdAt           DateTime            @default(now())
  updatedAt           DateTime            @updatedAt
  deletedAt           DateTime?           // Soft delete
  assignee            String?             // DEPRECATED - use assignedRekenaar/Tekenaar instead
  addressValid        Boolean             @default(false)
  werknummer          String?             // Work number for the project
  priority            Priority            @default(normal) // Admin-set urgency level
  deadline            DateTime?           // Optional deadline for the project
  
  // Team assignments
  assignedProjectleider String?           // Name of assigned Projectleider (Femke/Rohina)
  assignedRekenaar      String?           // Name of assigned Rekenaar
  assignedTekenaar      String?           // Name of assigned Tekenaar
  
  // Quote data
  quoteApproval       QuoteApprovalStatus @default(none)
  quoteValue          Float?
  quoteDescription    String?             // Engineer's justification for the quote
  quoteLineItems      Json?               // Array of {description: string, amount: number}
  quoteEstimatedHours Float?              // Estimated hours for the work
  quoteFeedback       Json?               // Array of admin feedback objects
  
  // Email automation tracking
  quoteSentAt           DateTime?         // When quote email was sent to client
  quoteReminder1SentAt  DateTime?         // First reminder sent
  quoteReminder2SentAt  DateTime?         // Second reminder sent
  orderConfirmSentAt    DateTime?         // Order confirmation sent
  deliveryNotifSentAt   DateTime?         // Delivery notification sent
  feedbackRequestSentAt DateTime?         // Feedback request sent
  npsSurveySentAt       DateTime?         // NPS survey sent
  referralInviteSentAt  DateTime?         // Referral invitation sent
  reactivationSentAt    DateTime?         // Reactivation email sent
  assigneeNotifiedAt    DateTime?         // When client was notified of engineer assignment
  
  // Relations
  specifications      ProjectSpec[]
  notes               Note[]
  activities          Activity[]
  documents           Document[]
  communications      Communication[]
  quoteVersions       QuoteVersion[]
  emailLogs           EmailLog[]
  timeEntries         TimeEntry[]

  @@index([status])
  @@index([assignee])
  @@index([createdAt])
  @@index([deletedAt])
  // Composite indexes for common query patterns
  @@index([assignee, status])        // "My leads" filtered by status
  @@index([quoteApproval, status])   // Approval queue queries
  @@index([status, createdAt])       // Pipeline sorting by date
  // Team assignment indexes
  @@index([assignedProjectleider])
  @@index([assignedRekenaar])
  @@index([assignedTekenaar])
}

model ProjectSpec {
  id        String   @id @default(cuid())
  leadId    String
  lead      Lead     @relation(fields: [leadId], references: [id], onDelete: Cascade)
  key       String
  value     String
  unit      String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([leadId, key])
}

model Note {
  id        String   @id @default(cuid())
  leadId    String
  lead      Lead     @relation(fields: [leadId], references: [id], onDelete: Cascade)
  content   String
  author    String
  reactions Json?    // Emoji reactions: { "üëç": ["User1", "User2"], "‚ù§Ô∏è": ["User3"] }
  createdAt DateTime @default(now())
}

model Activity {
  id        String   @id @default(cuid())
  leadId    String
  lead      Lead     @relation(fields: [leadId], references: [id], onDelete: Cascade)
  type      String   // 'status_change', 'email_sent', 'note_added', 'quote_generated', etc.
  content   String
  author    String?
  metadata  Json?    // For storing before/after states for audit
  createdAt DateTime @default(now())

  @@index([leadId])
  @@index([createdAt])
  @@index([type])
}

model User {
  id           String        @id @default(cuid())
  name         String
  email        String        @unique
  roleId       String?       // Foreign key to Role (nullable during migration)
  roleRef      Role?         @relation(fields: [roleId], references: [id])
  role         String        @default("engineer") // Legacy field - kept for backwards compatibility
  engineerType EngineerType? // Only for engineers: 'rekenaar' or 'tekenaar'
  avatar       String?
  createdAt    DateTime      @default(now())
  deletedAt    DateTime?     // Soft delete
  
  // Per-user permission overrides
  permissionOverrides UserPermission[]
  
  @@index([roleId])
}

// ============================================================
// RBAC (Role-Based Access Control) Models
// ============================================================

model Role {
  id          String   @id @default(cuid())
  name        String   @unique  // 'admin', 'projectleider', 'engineer', or custom
  displayName String             // 'Admin', 'Projectleider', etc.
  description String?
  color       String   @default("#6b7280")  // For UI badges (hex color)
  isSystem    Boolean  @default(false)       // System roles cannot be deleted
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  users       User[]
  permissions RolePermission[]
  
  @@index([isSystem])
}

model Permission {
  id          String   @id @default(cuid())
  key         String   @unique  // 'leads:edit', 'quotes:approve', etc.
  name        String             // 'Edit Leads', 'Approve Quotes'
  description String?
  category    String             // 'leads', 'quotes', 'admin', 'settings', 'team'
  sortOrder   Int      @default(0) // For consistent UI ordering
  
  rolePermissions RolePermission[]
  userPermissions UserPermission[]
  
  @@index([category])
}

model RolePermission {
  roleId       String
  permissionId String
  role         Role       @relation(fields: [roleId], references: [id], onDelete: Cascade)
  permission   Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)
  createdAt    DateTime   @default(now())
  
  @@id([roleId, permissionId])
}

model UserPermission {
  userId       String
  permissionId String
  granted      Boolean    @default(true)  // false = explicitly denied (override role permission)
  user         User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  permission   Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)
  createdAt    DateTime   @default(now())
  
  @@id([userId, permissionId])
}

model CostRate {
  id                String   @id @default(cuid())
  name              String
  basePrice         Float
  category          String   @default("base") // 'base', 'surcharge'
  isPercentage      Boolean  @default(false)
  projectType       String?  // Maps to project type for base rates (e.g., 'Dakkapel', 'Aanbouw')
  workSpecification String?  @db.Text // Detailed work description for this rate (shown on quote)
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  
  @@index([projectType])
}

// Document storage for leads
model Document {
  id         String    @id @default(cuid())
  leadId     String
  lead       Lead      @relation(fields: [leadId], references: [id], onDelete: Cascade)
  name       String
  type       String    // 'pdf', 'image', 'spreadsheet', 'dwg', 'other'
  category   String    // 'tekening', 'offerte', 'foto', 'vergunning', 'correspondentie', 'overig'
  size       Int       // in bytes
  url        String    // Supabase Storage URL
  status     String    @default("pending") // 'pending', 'approved', 'final'
  uploadedBy String
  createdAt  DateTime  @default(now())
  deletedAt  DateTime? // Soft delete

  @@index([leadId])
  @@index([category])
}

// Communication log (emails, calls)
model Communication {
  id        String   @id @default(cuid())
  leadId    String
  lead      Lead     @relation(fields: [leadId], references: [id], onDelete: Cascade)
  type      String   // 'email', 'call', 'whatsapp'
  direction String   // 'inbound', 'outbound'
  subject   String?
  content   String
  duration  Int?     // for calls, in seconds
  author    String
  createdAt DateTime @default(now())

  @@index([leadId])
  @@index([createdAt])
}

// Quote version history
model QuoteVersion {
  id          String   @id @default(cuid())
  leadId      String
  lead        Lead     @relation(fields: [leadId], references: [id], onDelete: Cascade)
  version     Int
  value       Float
  lineItems   Json     // Array of {description: string, amount: number}
  description String?
  status      String   // 'draft', 'submitted', 'approved', 'rejected', 'sent', 'accepted'
  createdBy   String
  createdAt   DateTime @default(now())
  
  // Secure link for client acceptance
  acceptanceHash    String?   @unique // Unique hash for secure acceptance URL
  hashExpiresAt     DateTime? // When the acceptance link expires
  
  // Acceptance tracking (legally binding evidence)
  acceptedAt        DateTime? // When client clicked "Accept"
  acceptedByEmail   String?   // Email address of acceptor
  acceptedFromIp    String?   // IP address for legal evidence
  acceptedUserAgent String?   // Browser/device info
  acceptanceNote    String?   // Any note client added during acceptance
  termsAccepted     Boolean   @default(false) // Explicit terms acceptance checkbox

  @@index([leadId])
  @@index([acceptanceHash])
  @@unique([leadId, version])
}

// Email templates
model EmailTemplate {
  id        String   @id @default(cuid())
  name      String   @unique
  subject   String
  body      String
  variables Json     // Array of variable names
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// Email send log
model EmailLog {
  id               String   @id @default(cuid())
  leadId           String?
  lead             Lead?    @relation(fields: [leadId], references: [id], onDelete: SetNull)
  templateId       String?
  automationFlowId String?  // Which automation flow (e.g., "01", "02", "03") triggered this email
  to               String
  subject          String
  body             String
  status           String   // 'sent', 'delivered', 'failed', 'bounced'
  messageId        String?  // From email provider
  error            String?
  sentBy           String
  openedAt         DateTime? // When email was first opened
  clickedAt        DateTime? // When link was first clicked
  createdAt        DateTime @default(now())

  @@index([leadId])
  @@index([createdAt])
  @@index([status])
  @@index([automationFlowId])
  @@index([messageId])
}

// Rate limiting storage
model RateLimit {
  id        String   @id
  count     Int      @default(1)
  expiresAt DateTime
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([expiresAt])
}

// Audit log for compliance
model AuditLog {
  id         String   @id @default(cuid())
  entityType String   // 'lead', 'user', 'quote', 'document'
  entityId   String
  action     String   // 'create', 'update', 'delete', 'restore'
  changes    Json     // Array of {field, oldValue, newValue}
  userId     String
  userName   String
  ipAddress  String?
  userAgent  String?
  createdAt  DateTime @default(now())

  @@index([entityType, entityId])
  @@index([userId])
  @@index([createdAt])
}

// Time tracking entries for engineers
model TimeEntry {
  id          String   @id @default(cuid())
  leadId      String?  // Nullable for general/non-project hours
  lead        Lead?    @relation(fields: [leadId], references: [id], onDelete: Cascade)
  userId      String
  userName    String
  date        DateTime // The date of the work
  startTime   String   // HH:mm format
  endTime     String   // HH:mm format
  duration    Int      // Duration in minutes
  description String
  category    String   // 'calculatie', 'overleg', 'administratie', 'site-bezoek', 'overig', 'algemeen', 'prive'
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([leadId])
  @@index([userId])
  @@index([date])
}

// Email Automation Configuration
model EmailAutomationConfig {
  id          String   @id @default(cuid())
  flowId      String   @unique // e.g., "01", "02", "03" - matches the automation ID
  name        String
  status      String   @default("active") // 'active', 'paused', 'draft'
  category    String   // 'klant', 'conversie', 'feedback', 'intern', 'campagne'
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

// Email Event Tracking (for webhooks from Resend)
model EmailEvent {
  id          String   @id @default(cuid())
  emailLogId  String?  // Reference to the original email log
  messageId   String?  // From email provider (Resend)
  eventType   String   // 'delivered', 'opened', 'clicked', 'bounced', 'complained'
  automationFlowId String? // Which automation flow this belongs to (e.g., "01", "02")
  metadata    Json?    // Additional data like click URLs, etc.
  createdAt   DateTime @default(now())

  @@index([messageId])
  @@index([eventType])
  @@index([automationFlowId])
  @@index([createdAt])
}

// User notifications (for @mentions, status changes, etc.)
model Notification {
  id          String   @id @default(cuid())
  userId      String   // The user who should see this notification
  userName    String   // Denormalized for display
  type        String   // 'mention', 'status_change', 'quote_feedback', 'document', 'assignment'
  title       String
  message     String
  leadId      String?  // Related lead (optional)
  leadName    String?  // Denormalized for display
  fromUserId  String?  // Who triggered the notification
  fromUserName String? // Denormalized for display
  read        Boolean  @default(false)
  createdAt   DateTime @default(now())

  @@index([userId, read])
  @@index([userId, createdAt])
  @@index([leadId])
}
